<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin â€” PollerÃ­a Malca's</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    .card { @apply bg-white/80 dark:bg-slate-800/60 backdrop-blur rounded-2xl shadow p-4; }
    .tag { @apply inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold; }
    .pill { @apply px-2 py-0.5 rounded-full text-xs bg-slate-200 dark:bg-slate-700; }
    .grid-cols-auto { grid-template-columns: 1fr auto; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen">

  <!-- Topbar -->
  <header class="sticky top-0 z-10 bg-white/80 dark:bg-slate-900/70 backdrop-blur border-b border-slate-200/60 dark:border-slate-700">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-lg md:text-xl font-bold">Admin â€” PollerÃ­a Malca's</h1>
      <span id="statusDot" class="ml-2 w-2.5 h-2.5 rounded-full bg-rose-400 inline-block" title="sin seÃ±al"></span>
      <span id="statusText" class="text-xs text-slate-500">esperando seÃ±alâ€¦</span>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnClear" class="px-3 py-1.5 rounded-lg bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600">Limpiar pedidos</button>
        <button id="btnExport" class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white">Exportar CSV</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto p-4 grid md:grid-cols-3 gap-4">
    <!-- Columna: Carrito en vivo -->
    <section class="md:col-span-1 card">
      <h2 class="text-base font-semibold mb-3">ðŸ›’ Carrito en vivo</h2>
      <div id="liveSubtotal" class="text-sm text-slate-500 mb-2">Subtotal: S/ 0.00</div>
      <div id="liveCart" class="space-y-2 text-sm">
        <div class="text-slate-500">Sin datos aÃºnâ€¦ abre la tienda en otra pestaÃ±a y agrega productos.</div>
      </div>
      <p class="text-[11px] text-slate-400 mt-3">Actualiza en tiempo real entre pestaÃ±as del mismo dispositivo y dominio.</p>
    </section>

    <!-- Columna: Resumen -->
    <section class="card">
      <h2 class="text-base font-semibold mb-3">ðŸ“ˆ Resumen</h2>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/30">
          <div class="text-slate-500">Pedidos hoy</div>
          <div id="kpiPedidos" class="text-2xl font-bold">0</div>
        </div>
        <div class="p-3 rounded-xl bg-indigo-50 dark:bg-indigo-900/30">
          <div class="text-slate-500">Total hoy</div>
          <div id="kpiTotal" class="text-2xl font-bold">S/ 0.00</div>
        </div>
      </div>
      <div class="mt-4">
        <div class="text-sm text-slate-500 mb-2">MÃ©todos de pago</div>
        <div id="kpiPagos" class="flex flex-wrap gap-2 text-xs"></div>
      </div>
    </section>

    <!-- Columna: Pedidos -->
    <section class="md:col-span-1 card md:col-span-2">
      <div class="flex items-center gap-2 mb-3">
        <h2 class="text-base font-semibold">ðŸ“¦ Pedidos</h2>
        <span class="pill" id="countOrders">0</span>
        <input id="q" class="ml-auto px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-sm" placeholder="Buscar: nombre, direcciÃ³n, productoâ€¦">
      </div>
      <div id="orders" class="divide-y divide-slate-200/60 dark:divide-slate-700"></div>
    </section>
  </main>

  <script>
    // ===== utils =====
    const $ = (q, c=document)=>c.querySelector(q);
    const $$ = (q, c=document)=>Array.from(c.querySelectorAll(q));
    const fmt = n => 'S/ ' + Number(n||0).toFixed(2);
    const key = 'malcas_orders';

    // ===== estado =====
    let orders = [];
    try { orders = JSON.parse(localStorage.getItem(key) || '[]'); } catch(_) {}

    // ===== realtime (escuchar) =====
    const bc = new BroadcastChannel('malcas_realtime');
    let lastBeat = 0;

    bc.onmessage = (ev) => {
      const { type, payload, at } = ev.data || {};
      if (!type) return;

      // pulso/status
      lastBeat = Date.now();
      setStatus(true);

      if (type === 'cart_update') {
        renderLiveCart(payload);
      }
      if (type === 'order_new') {
        upsertOrder(payload);
        renderAll();
      }
    };

    // latido visual
    function setStatus(online){
      const dot = $('#statusDot');
      const txt = $('#statusText');
      if (online) {
        dot.className = 'ml-2 w-2.5 h-2.5 rounded-full bg-emerald-500 inline-block';
        txt.textContent = 'conectado';
      } else {
        dot.className = 'ml-2 w-2.5 h-2.5 rounded-full bg-rose-400 inline-block';
        txt.textContent = 'esperando seÃ±alâ€¦';
      }
    }
    setInterval(()=> {
      const offline = (Date.now() - lastBeat) > 4000;
      setStatus(!offline);
    }, 1500);

    // ===== render carrito en vivo =====
    function renderLiveCart(data){
      const live = $('#liveCart');
      const sub = $('#liveSubtotal');
      if (!data || !data.cart || data.cart.length === 0) {
        live.innerHTML = '<div class="text-slate-500">Carrito vacÃ­oâ€¦</div>';
        sub.textContent = 'Subtotal: S/ 0.00';
        return;
      }
      sub.textContent = 'Subtotal: ' + fmt(data.subtotal);
      live.innerHTML = '';
      data.cart.forEach(p=>{
        const row = document.createElement('div');
        row.className = 'grid grid-cols-auto gap-2 items-center';
        row.innerHTML = \`
          <div>
            <div class="font-medium">\${p.qty}Ã— \${p.name}</div>
            <div class="text-xs text-slate-500">\${fmt(p.price)} c/u</div>
          </div>
          <div class="text-right font-semibold">\${fmt(p.price * p.qty)}</div>
        \`;
        live.appendChild(row);
      });
    }

    // ===== pedidos: CRUD local =====
    function upsertOrder(o){
      if (!o || !o.id) return;
      const i = orders.findIndex(x=>x.id===o.id);
      if (i>-1) orders[i]=o; else orders.unshift(o);
      localStorage.setItem(key, JSON.stringify(orders));
    }

    function clearOrders(){
      if (!confirm('Â¿Borrar todos los pedidos guardados en este dispositivo?')) return;
      orders = [];
      localStorage.setItem(key, '[]');
      renderAll();
    }

    // ===== render pedidos =====
    function renderAll(){
      // KPIs
      $('#countOrders').textContent = orders.length;

      const today = new Date().toISOString().slice(0,10);
      const todayOrders = orders.filter(o => (o.created_at||'').slice(0,10) === today);
      const totalToday = todayOrders.reduce((s,o)=>s + Number(o.total||0), 0);
      $('#kpiPedidos').textContent = todayOrders.length;
      $('#kpiTotal').textContent = fmt(totalToday);

      // pagos
      const map = {};
      todayOrders.forEach(o => { map[o.pago] = (map[o.pago]||0) + 1; });
      const pagos = $('#kpiPagos');
      pagos.innerHTML = '';
      Object.entries(map).forEach(([k,v])=>{
        const b = document.createElement('span');
        b.className = 'tag bg-slate-200 dark:bg-slate-700';
        b.textContent = k + ': ' + v;
        pagos.appendChild(b);
      });

      // lista
      const q = ($('#q').value||'').toLowerCase();
      const list = $('#orders');
      list.innerHTML = '';

      orders
        .filter(o => {
          if (!q) return true;
          const hay = [
            o.nombre, o.direccion, o.pago, o.productos,
            ...(o.items||[]).map(i=>i.name)
          ].join(' ').toLowerCase();
          return hay.includes(q);
        })
        .forEach(o=>{
          const div = document.createElement('div');
          div.className = 'py-3';
          const dt = new Date(o.created_at||Date.now());
          const when = dt.toLocaleString();
          const itemsHtml = (o.items||[]).map(i => \`\${i.qty}Ã— \${i.name} â€” \${fmt(i.price * i.qty)}\`).join('<br>');

          div.innerHTML = \`
            <div class="flex gap-2 items-start">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <strong>\${o.nombre||'-'}</strong>
                  <span class="pill">\${o.pago||'-'}</span>
                  <span class="text-xs text-slate-500">#\${o.id}</span>
                </div>
                <div class="text-sm text-slate-600 dark:text-slate-300">\${o.direccion||''}</div>
                <div class="mt-2 text-sm">\${itemsHtml || (o.productos||'')}</div>
                <div class="mt-1 text-[11px] text-slate-500">\${when}</div>
              </div>
              <div class="text-right">
                <div class="text-base font-bold">\${fmt(o.total||0)}</div>
                <button class="mt-2 px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs del">Eliminar</button>
              </div>
            </div>
          \`;

          div.querySelector('.del').addEventListener('click', ()=>{
            if (!confirm('Â¿Eliminar este pedido del dispositivo?')) return;
            orders = orders.filter(x=>x.id !== o.id);
            localStorage.setItem(key, JSON.stringify(orders));
            renderAll();
          });

          list.appendChild(div);
        });
    }

    // ===== eventos ui =====
    $('#btnClear').addEventListener('click', clearOrders);
    $('#q').addEventListener('input', renderAll);

    // export CSV
    $('#btnExport').addEventListener('click', ()=>{
      const rows = [
        ['id','fecha','nombre','direccion','pago','productos','total']
      ];
      orders.forEach(o=>{
        rows.push([
          o.id,
          o.created_at,
          o.nombre||'',
          o.direccion||'',
          o.pago||'',
          o.productos||'',
          (o.total||0)
        ]);
      });
      const csv = rows.map(r => r.map(x=>{
        const s = String(x).replace(/\"/g,'""');
        return `"${s}"`;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pedidos-malcas.csv';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    });

    // render inicial
    renderAll();
  </script>
</body>
</html>
